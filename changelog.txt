Refactor metadata updates to track completion state and changes
